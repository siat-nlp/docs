



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>DL Framework Programming - NLP and DL Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="manifest" href="../manifest.webmanifest">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#deep-learning-framework-programming" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="NLP and DL Docs" class="md-header-nav__button md-logo">
          
            <img src="../images/logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              NLP and DL Docs
            </span>
            <span class="md-header-nav__topic">
              DL Framework Programming
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/siat-nlp/NLP-DL-Tricks/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    siat-nlp/NLP-DL-Tricks
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href=".." title="Documentation" class="md-tabs__link md-tabs__link--active">
          Documentation
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../baselines/question_answering/" title="Baselines" class="md-tabs__link">
          Baselines
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../helper/" title="About" class="md-tabs__link">
          About
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="NLP and DL Docs" class="md-nav__button md-logo">
      
        <img src="../images/logo.svg" width="48" height="48">
      
    </a>
    NLP and DL Docs
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/siat-nlp/NLP-DL-Tricks/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    siat-nlp/NLP-DL-Tricks
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" checked>
    
    <label class="md-nav__link" for="nav-1">
      Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="NLP and DL Tricks" class="md-nav__link">
      NLP and DL Tricks
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        DL Framework Programming
      </label>
    
    <a href="./" title="DL Framework Programming" class="md-nav__link md-nav__link--active">
      DL Framework Programming
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#programming-in-tensorflow" title="Programming in Tensorflow" class="md-nav__link">
    Programming in Tensorflow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tfvariable_scope-tfname_scope" title="tf.variable_scope / tf.name_scope" class="md-nav__link">
    tf.variable_scope / tf.name_scope
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-save-restore" title="Model Save / Restore" class="md-nav__link">
    Model Save / Restore
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#programming-in-pytorch" title="Programming in PyTorch" class="md-nav__link">
    Programming in PyTorch
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-out-of-memory" title="CUDA out of memory" class="md-nav__link">
    CUDA out of memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#online-tensorflow-serving" title="Online Tensorflow Serving" class="md-nav__link">
    Online Tensorflow Serving
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-deploy" title="How to deploy" class="md-nav__link">
    How to deploy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-your-model-in-the-running-docker" title="Deploy your model in the running docker" class="md-nav__link">
    Deploy your model in the running docker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial/" title="Useful Tutorials" class="md-nav__link">
      Useful Tutorials
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Baselines
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Baselines
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../baselines/question_answering/" title="Question Answering" class="md-nav__link">
      Question Answering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../baselines/answer_selection/" title="Answer Selection" class="md-nav__link">
      Answer Selection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../baselines/aspect/" title="Aspect Sentiment Analysis" class="md-nav__link">
      Aspect Sentiment Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../baselines/dialogue/" title="Dialogue" class="md-nav__link">
      Dialogue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../baselines/summarization/" title="Summarization" class="md-nav__link">
      Summarization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../baselines/captioning/" title="Captioning" class="md-nav__link">
      Captioning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../helper/" title="Writing Tutorial" class="md-nav__link">
      Writing Tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../helper/writing_paradigm/" title="Writing Paradigm" class="md-nav__link">
      Writing Paradigm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../helper/element/" title="Element" class="md-nav__link">
      Element
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#programming-in-tensorflow" title="Programming in Tensorflow" class="md-nav__link">
    Programming in Tensorflow
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tfvariable_scope-tfname_scope" title="tf.variable_scope / tf.name_scope" class="md-nav__link">
    tf.variable_scope / tf.name_scope
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-save-restore" title="Model Save / Restore" class="md-nav__link">
    Model Save / Restore
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#programming-in-pytorch" title="Programming in PyTorch" class="md-nav__link">
    Programming in PyTorch
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuda-out-of-memory" title="CUDA out of memory" class="md-nav__link">
    CUDA out of memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#online-tensorflow-serving" title="Online Tensorflow Serving" class="md-nav__link">
    Online Tensorflow Serving
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-deploy" title="How to deploy" class="md-nav__link">
    How to deploy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-your-model-in-the-running-docker" title="Deploy your model in the running docker" class="md-nav__link">
    Deploy your model in the running docker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/siat-nlp/NLP-DL-Tricks/tree/edit/nlpdocument/docs/dl_framework.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="deep-learning-framework-programming">Deep Learning Framework Programming<a class="headerlink" href="#deep-learning-framework-programming" title="Permanent link">&para;</a></h1>
<h2 id="programming-in-tensorflow">Programming in Tensorflow<a class="headerlink" href="#programming-in-tensorflow" title="Permanent link">&para;</a></h2>
<h3 id="tfvariable_scope-tfname_scope">tf.variable_scope / tf.name_scope<a class="headerlink" href="#tfvariable_scope-tfname_scope" title="Permanent link">&para;</a></h3>
<p>Both scopes have the same effect on all operations as well as variables, but <em>name scope</em> is ignored by <code class="codehilite"><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span></code>. Suggest use <code class="codehilite"><span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span></code> in most cases. </p>
<div class="admonition info">
<p class="admonition-title">Ref</p>
<p>The difference between name scope and variable scope in tensorflow at <a href="https://stackoverflow.com/questions/35919020/whats-the-difference-of-name-scope-and-a-variable-scope-in-tensorflow">stackoverflow</a>.</p>
</div>
<h3 id="model-save-restore">Model Save / Restore<a class="headerlink" href="#model-save-restore" title="Permanent link">&para;</a></h3>
<p>Usually, we create a helper <code>saver = tf.train.Saver()</code> to save and restore the whole model. However, if we want to use pre-trained model for fine-tuning or transfer learning, there are 2 ways: (1) Create the network by writing code to create each and every layer manually as the original model, and then use <code>tf.train.Saver()</code> to restore pre-trained model's checkpoint file. (2) Use <code>.meta</code> file and create the helper as <code>saver = tf.train.import_meta_graph('xxx_model-xxx.meta')</code> and then restore the pre-trained model. </p>
<div class="admonition info">
<p class="admonition-title">Ref</p>
<p>More details are in this <a href="https://cv-tricks.com/tensorflow-tutorial/save-restore-tensorflow-models-quick-complete-tutorial/">tutorial</a>.</p>
</div>
<h2 id="programming-in-pytorch">Programming in PyTorch<a class="headerlink" href="#programming-in-pytorch" title="Permanent link">&para;</a></h2>
<h3 id="cuda-out-of-memory">CUDA out of memory<a class="headerlink" href="#cuda-out-of-memory" title="Permanent link">&para;</a></h3>
<p>When <code>RuntimeError: CUDA out of memory</code> occurs, usually (1) check if exists too large tensors in computation graph; (2) downsize the batch size; (3) or use multiple GPUs to train. Note to split batch size when using <code>nn.DataParallel</code>. </p>
<div class="admonition info">
<p class="admonition-title">Ref</p>
<p>Some other details are in this <a href="https://docs.google.com/document/d/1Cpxs-aZcydqCzTEvfW-62ja6ZDhx2QEXR-f5HKmbeig/edit?usp=sharing">debug log</a>.</p>
</div>
<h2 id="online-tensorflow-serving">Online Tensorflow Serving<a class="headerlink" href="#online-tensorflow-serving" title="Permanent link">&para;</a></h2>
<p>TensorFlow Serving is a flexible, high-performance serving system for machine learning models, designed for production environments. Servables are the central abstraction in TensorFlow Serving. Servables are the underlying objects that clients use to perform computation (for example, a lookup or inference).</p>
<p>The size and granularity of a Servable is flexible. A single Servable might include anything from a single shard of a lookup table to a single model to a tuple of inference models. Servables can be of any type and interface, enabling flexibility and future improvements such as: streaming results, experimental APIs, asynchronous modes of operation.</p>
<h3 id="how-to-deploy">How to deploy<a class="headerlink" href="#how-to-deploy" title="Permanent link">&para;</a></h3>
<p>Tensorflow Serving follows the server-client architecture. While training a specific model, save it in the mode that can be used by tensorflow-serving. Deploy your model on a running docker to provide service. For clients, request server for prediction results of given data instances. The following is an example of the deployment procedure.</p>
<p><strong>Save a trained model</strong></p>
<p>The common way to save model in tensorflow looks like,</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>saver.save(session, checkpoint_prefix, global_step=current_step)
tf.train.write_graph(sess.graph.as_graph_def(), checkpoint_prefix, &quot;graph&quot;+str(nn)+&quot;.pb&quot;, as_text=False)
</pre></div>
</td></tr></table>
For tensorflow serving, we save like,
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>### define input&amp;output signature
signature = tf.saved_model.signature_def_utils.build_signature_def(
inputs={
   &#39;input_x1&#39;: tf.saved_model.utils.build_tensor_info(self.input_x1),
   &#39;input_x2&#39;: tf.saved_model.utils.build_tensor_info(self.input_x2),
   &#39;ent_x1&#39;: tf.saved_model.utils.build_tensor_info(self.ent_x1),
   &#39;ent_x2&#39;: tf.saved_model.utils.build_tensor_info(self.ent_x2),
   &#39;input_y&#39;: tf.saved_model.utils.build_tensor_info(self.input_y),
   &#39;add_fea&#39;: tf.saved_model.utils.build_tensor_info(self.add_fea),
   &#39;dropout_keep_prob&#39;: tf.saved_model.utils.build_tensor_info(self.dropout_keep_prob)
},
outputs={
   &#39;output&#39;: tf.saved_model.utils.build_tensor_info(self.soft_prob)
},
method_name=tf.saved_model.signature_constants.PREDICT_METHOD_NAME
)
### saving 
builder = tf.saved_model.builder.SavedModelBuilder(graph_save_dir)
builder.add_meta_graph_and_variables(sess, [tf.saved_model.tag_constants.SERVING], {tf.saved_model.signature_constants.DEFAULT_SERVING_SIGNATURE_DEF_KEY: signature})
builder.save()
</pre></div>
</td></tr></table>
Define your own inputs and outputs according to the task.</p>
<p><strong>Run a serving docker and deploy your model</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># pull a tensorflow-serving image
$ sudo docker pull tensorflow/serving:latest-devel
# run the serving docker
$ sudo docker run -it -p 8500:8500 tensorflow/serving:latest-devel
# copy your model file to the running docker (change the docker ID and your model path)
$ sudo docker cp /data/huangweiyi/qaModel/code/kaaqa/runs/model 6d7d70e27ecc:/online_qa_model
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You need to create different version of your model for tensorflow-serving (refer to <a href="https://stackoverflow.com/questions/45544928/tensorflow-serving-no-versions-of-servable-model-found-under-base-path">https://stackoverflow.com/questions/45544928/tensorflow-serving-no-versions-of-servable-model-found-under-base-path</a>)</p>
</div>
<h3 id="deploy-your-model-in-the-running-docker">Deploy your model in the running docker<a class="headerlink" href="#deploy-your-model-in-the-running-docker" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ tensorflow_model_server --port=8500 --model_name=qa --model_base_path=/online_qa_model
</pre></div>
</td></tr></table>

<p><strong>Request the server for prediction results</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>hostport = &#39;172.17.0.2:8500&#39;
channel = grpc.insecure_channel(hostport)
stub = prediction_service_pb2_grpc.PredictionServiceStub(channel)

request = predict_pb2.PredictRequest()
request.model_spec.name = &#39;qa&#39;

inpH = InputHelper()
x1_test, x2_test, ent_x1_test, ent_x2_test, y_test, x1_temp, x2_temp, add_fea_test = inpH.getTestSample(question, candidates)
batches = inpH.batch_iter(list(zip(x1_test, x2_test, ent_x1_test, ent_x2_test, y_test, add_fea_test)), 10000, 1, shuffle=False)
for db in batches:
   x1_dev_b, x2_dev_b, ent_x1_dev_b, ent_x2_dev_b, y_dev_b, add_fea_dev_b = zip(*db)
   for idx in range(len(x1_dev_b)):
       feature_dict = {
           &quot;input_x1&quot;: x1_dev_b,
           &quot;input_x2&quot;: x2_dev_b,
           &quot;ent_x1&quot;: ent_x1_dev_b,
           &quot;ent_x2&quot;: ent_x2_dev_b,
           &quot;input_y&quot;: y_dev_b,
           &quot;add_fea&quot;: add_fea_dev_b,
           &quot;dropout_keep_prob&quot;: 1,
       }
       for key in [&#39;input_x1&#39;, &#39;input_x2&#39;, &#39;ent_x1&#39;, &#39;ent_x2&#39;]:
           value = feature_dict.get(key)[idx].astype(np.int32)
           request.inputs[key].CopyFrom(tf.contrib.util.make_tensor_proto(value, shape=[1, value.size]))
       request.inputs[&#39;dropout_keep_prob&#39;].CopyFrom(tf.contrib.util.make_tensor_proto(1.0, shape=[1]))
       request.inputs[&#39;input_y&#39;].CopyFrom(tf.contrib.util.make_tensor_proto(1, shape=[1], dtype=np.int64))
       value = add_fea_dev_b[0].astype(np.float32)
       request.inputs[&#39;add_fea&#39;].CopyFrom(tf.contrib.util.make_tensor_proto(value, shape=[1, value.size]))

       result_future = stub.Predict.future(request, 3.0)
       score = np.array(result_future.result().outputs[&#39;output&#39;].float_val)[1]
</pre></div>
</td></tr></table>

<p>Modify "feature_dict" according to your input variables. The variable "score" is the model output for your request instance. For more details, please refer to <a href="http://210.75.252.89:3000/hweiyi/aiLawAssistant/src/branch/master/ranking/client.py">http://210.75.252.89:3000/hweiyi/aiLawAssistant/src/branch/master/ranking/client.py</a> for all the codes.</p>
<div class="admonition info">
<p class="admonition-title">Ref</p>
<p>A detailed illustration of saving model for tensorflow-serving (<a href="https://zhuanlan.zhihu.com/p/40226973">https://zhuanlan.zhihu.com/p/40226973</a>)</p>
</div>
<div class="admonition info">
<p class="admonition-title">Ref</p>
<p>Documents of tensorflow-serving (<a href="https://bookdown.org/leovan/TensorFlow-Learning-Notes/4-5-deploy-tensorflow-serving.html#using-tensorflow-serving-via-docker--docker--tensorflow-serving">https://bookdown.org/leovan/TensorFlow-Learning-Notes/4-5-deploy-tensorflow-serving.html#using-tensorflow-serving-via-docker--docker--tensorflow-serving</a>)</p>
</div>
<div class="admonition info">
<p class="admonition-title">Ref</p>
<p>An officail example (<a href="https://github.com/tensorflow/serving/tree/master/tensorflow_serving/example">https://github.com/tensorflow/serving/tree/master/tensorflow_serving/example</a>)</p>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="NLP and DL Tricks" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                NLP and DL Tricks
              </span>
            </div>
          </a>
        
        
          <a href="../tutorial/" title="Useful Tutorials" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Useful Tutorials
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by SIAT NLP Group
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/siat-nlp" class="md-footer-social__link fa fa-fas fa-home"></a>
    
      <a href="https://github.com/siat-nlp/docs" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>